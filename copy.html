<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Visitors — Admin Dashboard</title>

<style>
body{
  font-family:Inter,system-ui,sans-serif;
  margin:0;padding:20px;
  background:#f6f8fb;color:#111
}
header{
  display:flex;flex-wrap:wrap;
  align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:18px
}
.card{
  background:#fff;padding:12px;border-radius:10px;
  box-shadow:0 6px 20px rgba(14,20,30,.06)
}
.controls{
  display:flex;flex-wrap:wrap;gap:8px;align-items:center
}
select,input[type="date"],input[type="search"],button{
  padding:8px 10px;border-radius:8px;
  border:1px solid #ddd;font-size:13px
}
input[type="search"]{min-width:220px}
button{
  background:#1f8ef1;color:#fff;border:0;cursor:pointer
}
.small{font-size:12px;color:#666}
.table-wrap{max-height:60vh;overflow:auto;margin-top:12px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{
  padding:8px 10px;border-bottom:1px solid #f0f0f0;
  vertical-align:top;text-align:left
}
th{
  background:#fafafa;font-weight:600;
  position:sticky;top:0
}
@media(max-width:720px){
  th:nth-child(n+6),td:nth-child(n+6){display:none}
}
</style>
</head>

<body>

<header>
  <div>
    <h2 style="margin:0">Visitor Analytics</h2>
    <div class="small">Realtime student activity logs</div>
  </div>

  <div class="controls">
    <input type="search" id="searchBox" placeholder="Search IP, city, device, page">

    <select id="filterCountry"><option value="">All Countries</option></select>
    <select id="filterDevice"><option value="">All Devices</option></select>
    <select id="filterPage"><option value="">All Pages</option></select>

    <label>From <input type="date" id="fromDate"></label>
    <label>To <input type="date" id="toDate"></label>

    <button id="btnRefresh">Refresh</button>
    <button id="btnExport">Export CSV</button>
  </div>
</header>

<div class="card">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>IP / City</th>
          <th>Country</th>
          <th>Device</th>
          <th>Browser</th>
          <th>Screen</th>
          <th>Page / Referrer</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= FIREBASE ================= */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyBK5UM0n8-GLvleW7l6B8Hi-_WuC64QA4U",
    authDomain: "scores-b25a7.firebaseapp.com",
    databaseURL: "https://scores-b25a7-default-rtdb.firebaseio.com",
    projectId: "scores-b25a7"
  });
}
const db = firebase.database();
/* ============================================ */

const tbody = document.getElementById('tbody');
const fromDate = document.getElementById('fromDate');
const toDate = document.getElementById('toDate');
const filterCountry = document.getElementById('filterCountry');
const filterDevice = document.getElementById('filterDevice');
const filterPage = document.getElementById('filterPage');
const searchBox = document.getElementById('searchBox');
const btnRefresh = document.getElementById('btnRefresh');
const btnExport = document.getElementById('btnExport');

let visitors = [];

/* ================= RENDER ================= */
function renderTable(list){
  tbody.innerHTML='';
  if(!list.length){
    tbody.innerHTML='<tr><td colspan="7" class="small">No records found</td></tr>';
    return;
  }
  list.forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${v.timestamp || ''}</td>
      <td>${v.ip || ''}${v.city ? ' / '+v.city : ''}</td>
      <td>${v.country || ''}</td>
      <td>${v.deviceType || ''}</td>
      <td>${v.browser?.name || ''} ${v.browser?.version || ''}</td>
      <td>${v.screen?.width || ''}×${v.screen?.height || ''}</td>
      <td>${v.page || ''}<div class="small">${v.referrer || ''}</div></td>
    `;
    tbody.appendChild(tr);
  });
}
/* =========================================== */

function populateFilters(){
  const countries=new Set(), devices=new Set(), pages=new Set();
  visitors.forEach(v=>{
    if(v.country) countries.add(v.country);
    if(v.deviceType) devices.add(v.deviceType);
    if(v.page) pages.add(v.page);
  });

  filterCountry.innerHTML='<option value="">All Countries</option>';
  [...countries].sort().forEach(v=>filterCountry.innerHTML+=`<option>${v}</option>`);

  filterDevice.innerHTML='<option value="">All Devices</option>';
  [...devices].sort().forEach(v=>filterDevice.innerHTML+=`<option>${v}</option>`);

  filterPage.innerHTML='<option value="">All Pages</option>';
  [...pages].sort().forEach(v=>filterPage.innerHTML+=`<option>${v}</option>`);
}

function applyFilters(){
  let list=[...visitors];
  const from=fromDate.value?new Date(fromDate.value+'T00:00'):null;
  const to=toDate.value?new Date(toDate.value+'T23:59'):null;
  const q=searchBox.value.toLowerCase();

  if(from) list=list.filter(v=>new Date(v.timestamp)>=from);
  if(to) list=list.filter(v=>new Date(v.timestamp)<=to);
  if(filterCountry.value) list=list.filter(v=>v.country===filterCountry.value);
  if(filterDevice.value) list=list.filter(v=>v.deviceType===filterDevice.value);
  if(filterPage.value) list=list.filter(v=>v.page===filterPage.value);

  if(q){
    list=list.filter(v =>
      `${v.ip} ${v.city} ${v.country} ${v.deviceType} ${v.page} ${v.referrer} ${v.browser?.name}`
        .toLowerCase().includes(q)
    );
  }

  renderTable(list);
}

/* ================= FETCH ================= */
async function fetchVisitors(){
  const snap=await db.ref('visitors').once('value');
  visitors=Object.values(snap.val()||{})
    .sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
  populateFilters();
  applyFilters();
}

btnRefresh.onclick=fetchVisitors;
[fromDate,toDate,filterCountry,filterDevice,filterPage,searchBox]
  .forEach(el=>el.addEventListener('input',applyFilters));

/* ================= EXPORT ================= */
btnExport.onclick=()=>{
  const rows=[...tbody.querySelectorAll('tr')].map(tr=>
    [...tr.children].map(td=>td.innerText.replace(/\n/g,' '))
  );
  const csv=[['timestamp','ip/city','country','device','browser','screen','page/referrer']]
    .concat(rows)
    .map(r=>r.map(c=>`"${c.replace(/"/g,'""')}"`).join(','))
    .join('\n');

  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='visitors.csv';
  a.click();
};

fetchVisitors();
</script>

</body>
</html>
